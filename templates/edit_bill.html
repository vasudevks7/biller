<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Bill</title>
  <style>
    :root {
      --accent: #0b6cf0;
      --success: #16a34a;
      --bg: #f3f4f6;
      --card: #ffffff;
      --shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 16px;
      color: #111827;
    }
    .container {
      background: var(--card);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    h2 { text-align: center; margin-bottom: 16px; font-size: 1.4rem; }
    label { font-weight: 600; display: block; margin-top: 10px; margin-bottom: 4px; }
    input[type="text"], input[type="number"], input[type="date"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 15px;
      background: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
    }
    button {
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }
    .add-btn {
      background: var(--accent);
      color: #fff;
      width: 100%;
      margin-top: 10px;
    }
    .add-btn:hover { background: #095ad3; }
    .save-btn {
      background: var(--success);
      color: #fff;
      width: 100%;
      font-size: 1rem;
      margin-top: 16px;
    }
    .save-btn:hover { background: #138f3b; }
    .summary {
      text-align: right;
      margin-top: 20px;
      border-top: 1px solid #e5e7eb;
      padding-top: 10px;
    }
    .summary div {
      margin: 4px 0;
      font-size: 15px;
    }
    @media (max-width: 700px) {
      .container { padding: 16px; }
      h2 { font-size: 1.2rem; }
      table { font-size: 13px; }
      th, td { padding: 6px; }
      input[type="text"], input[type="number"], input[type="date"] { font-size: 14px; }
      button { font-size: 14px; }
    }
    @media (max-width: 500px) {
      table thead { display: none; }
      table, table tbody, table tr, table td { display: block; width: 100%; }
      table tr { margin-bottom: 14px; border: 1px solid #e5e7eb; border-radius: 10px; overflow: hidden; }
      table td { text-align: left; padding: 10px; border: none; border-bottom: 1px solid #f1f5f9; }
      table td:last-child { border-bottom: none; }
      table td::before { content: attr(data-label); font-weight: 600; display: block; margin-bottom: 4px; color: #374151; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚úèÔ∏è Edit Bill</h2>

    <label>Customer Name:</label>
    <input type="text" id="customer_name" placeholder="Enter customer name">

    <label>Date:</label>
    <input type="date" id="date">

    <label>Invoice Number:</label>
    <input type="text" id="invoice_number" placeholder="001">

    <label>Tax Type:</label>
    <select id="tax_type">
        <option value="IGST" {% if bill['tax_type'] == 'IGST' %}selected{% endif %}>IGST</option>
        <option value="CGST/SGST" {% if bill['tax_type'] == 'CGST/SGST' %}selected{% endif %}>CGST/SGST</option>
    </select>


    <h3 style="margin-top:16px;">Items</h3>
    <table id="itemsTable">
      <thead>
        <tr>
            <th>Item Name</th>
            <th>HSN</th>
            <th>Qty</th>
            <th>Rate</th>
            <th>Tax %</th>
            <th>Tax (‚Çπ)</th>
            <th>Total (with Tax)</th>
            <th>Delete</th>

        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p><button class="add-btn" onclick="addRow()">+ Add Item</button></p>

    <!-- NEW: Extra Charge Inputs -->
    <div style="margin-top:20px;">
      <label>Extra Charge Title:</label>
      <input type="text" id="extra_title" placeholder="e.g. Delivery Charge">

      <label>Amount (‚Çπ):</label>
      <input type="number" id="extra_amount" placeholder="0.00" value="0" step="0.01" oninput="refresh()">
    </div>

    <div class="summary">
      <div>Subtotal: ‚Çπ<span id="subtotal">0.00</span></div>
      <div>Total Tax: ‚Çπ<span id="totalTax">0.00</span></div>
      <div>Extra: ‚Çπ<span id="showExtra">0.00</span></div> <!-- NEW -->
      <div><strong>Grand Total: ‚Çπ<span id="grandTotal">0.00</span></strong></div>
    </div>

    <button class="save-btn" onclick="updateBill()">üíæ Update Bill</button>
  </div>

  <script>
    const tbody = document.querySelector('#itemsTable tbody');

    function addRow(prefill) {
      const taxDefault = (prefill && prefill.taxp !== undefined) ? prefill.taxp : 18;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td data-label="Item Name"><input class="iname" type="text" value="${prefill ? prefill.name : ''}" placeholder="Item name"></td>
        <td data-label="HSN"><input class="ihsn" type="text" value="${prefill ? prefill.hsn || '' : ''}" placeholder="HSN Code"></td>
        <td data-label="Qty"><input class="iqty" type="number" min="0" step="1" value="${prefill ? prefill.qty : 1}" onchange="refresh()"></td>
        <td data-label="Rate"><input class="irate" type="number" min="0" step="0.01" value="${prefill ? prefill.rate : 0}" onchange="refresh()"></td>
        <td data-label="Tax %"><input class="itaxp" type="number" min="0" step="0.01" value="${taxDefault}" onchange="refresh()"></td>
        <td data-label="Tax (‚Çπ)" class="itax">0.00</td>
        <td data-label="Total (with Tax)" class="itotal">0.00</td>
        <td><button style="background-color:red;color:white;padding:8px" onclick="removeRow(this)">Delete</button></td>
      `;
      tbody.appendChild(row);
      refresh();
    }

    function removeRow(btn) {
      btn.closest('tr').remove();
      refresh();
    }

    function refresh() {
      let subtotal = 0, totalTax = 0;
      tbody.querySelectorAll('tr').forEach(tr => {
        const qty = parseFloat(tr.querySelector('.iqty').value) || 0;
        const rate = parseFloat(tr.querySelector('.irate').value) || 0;
        const taxp = parseFloat(tr.querySelector('.itaxp').value) || 0;
        const itemSub = qty * rate;
        const itemTax = itemSub * (taxp / 100);
        const itemTotal = itemSub + itemTax;
        tr.querySelector('.itax').textContent = itemTax.toFixed(2);
        tr.querySelector('.itotal').textContent = itemTotal.toFixed(2);
        subtotal += itemSub;
        totalTax += itemTax;
      });

      const extra = parseFloat(document.getElementById('extra_amount').value) || 0;
      document.getElementById('subtotal').textContent = subtotal.toFixed(2);
      document.getElementById('totalTax').textContent = totalTax.toFixed(2);
      document.getElementById('showExtra').textContent = extra.toFixed(2);
      document.getElementById('grandTotal').textContent = (subtotal + totalTax + extra).toFixed(2);
    }

    function gatherItems() {
      const items = [];
      tbody.querySelectorAll('tr').forEach(tr => {
        const name = tr.querySelector('.iname').value || '';
        const hsn = tr.querySelector('.ihsn').value || '';
        items.push({ name, hsn, qty, rate, taxp, tax: itemTax, total: itemTotal });
        const qty = parseFloat(tr.querySelector('.iqty').value) || 0;
        const rate = parseFloat(tr.querySelector('.irate').value) || 0;
        const taxp = parseFloat(tr.querySelector('.itaxp').value) || 0;
        const itemSub = qty * rate;
        const itemTax = itemSub * (taxp / 100);
        const itemTotal = itemSub + itemTax;
        if (name && qty > 0 && rate >= 0) {
          items.push({ name, qty, rate, taxp, tax: itemTax, total: itemTotal });
        }
      });
      return items;
    }

    const billData = {{ bill|tojson }};
    const items = {{ items|tojson }};
    document.getElementById('customer_name').value = billData.customer_name;
    document.getElementById('date').value = billData.date;
    document.getElementById('invoice_number').value = billData.invoice_number;
    document.getElementById('extra_title').value = billData.extra_title || '';
    document.getElementById('extra_amount').value = billData.extra_amount || 0;
    items.forEach(it => addRow(it));
    refresh();

    async function updateBill() {
      const items = gatherItems();
      const payload = {
        bill_id: billData.id,
        date: document.getElementById('date').value,
        invoice_number: document.getElementById('invoice_number').value,
        tax_type: document.getElementById('tax_type').value,
        customer_name: document.getElementById('customer_name').value,
        extra_title: document.getElementById('extra_title').value,
        extra_amount: Number(document.getElementById('extra_amount').value),
        grand_total: Number(document.getElementById('grandTotal').textContent),
        items
      };

      const res = await fetch('/update-bill', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      alert(j.message);
      window.location.href = '/history';
    }
  </script>
</body>
</html>
