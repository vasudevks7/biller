<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tax Invoice - {{ bill['invoice_number'] }}</title>

  <style>
    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Arial", sans-serif;
      background: #f8fafc;
      color: #222;
      line-height: 1.4;
      padding: 10px;
    }

    .invoice-box {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* HEADER */
    .invoice-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #114a91;
    }

    .company-info h1 {
      font-size: 22px;
      color: #114a91;
      margin-bottom: 5px;
    }

    .company-info p {
      font-size: 13px;
      margin-bottom: 2px;
    }

    .logo-container img {
      max-height: 70px;
      width: auto;
    }

    .invoice-title {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      color: #114a91;
      margin: 15px 0;
      text-transform: uppercase;
      padding-bottom: 10px;
      border-bottom: 1px solid #e2e8f0;
    }

    /* DETAILS SECTION */
    .details-section {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 15px;
    }

    .customer-details, .invoice-details {
      font-size: 13px;
      padding: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      background: #f8fafc;
    }

    .customer-details {
      flex: 1.3;
    }

    .invoice-details {
      flex: 0.8;
    }

    .section-title {
      font-weight: bold;
      color: #114a91;
      margin-bottom: 8px;
      font-size: 14px;
      padding-bottom: 5px;
      border-bottom: 1px solid #cbd5e1;
    }

    .detail-row {
      display: flex;
      font-size: 13px;
      margin-bottom: 4px;
      padding-bottom: 4px;
      border-bottom: 1px dotted #e2e8f0;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      width: 80px;
      font-weight: bold;
    }

    .detail-value {
      flex: 1;
    }

    /* ITEMS SECTION */
    .items-section {
      margin: 20px 0;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }

    .items-section .section-title {
      padding: 10px 12px;
      background: #f1f5f9;
      margin: 0;
      border-bottom: 1px solid #e2e8f0;
      border-radius: 0;
    }

    .items-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .items-table th {
      text-align: left;
      padding: 10px 8px;
      background: #f8fafc;
      color: #114a91;
      font-weight: bold;
      border-bottom: 2px solid #114a91;
    }

    .items-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #e2e8f0;
    }

    .items-table tr:last-child td {
      border-bottom: none;
    }

    /* TOTALS */
    .totals-section {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
    }

    .totals-table {
      width: 280px;
      border-collapse: collapse;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }

    .totals-table td {
      padding: 8px 12px;
      font-size: 13px;
      text-align: right;
      border-bottom: 1px solid #e2e8f0;
    }

    .totals-table tr:last-child td {
      font-weight: bold;
      color: #114a91;
      background: #f8fafc;
      border-top: 2px solid #114a91;
    }

    .amount-words {
      margin-top: 15px;
      font-size: 13px;
      padding: 10px;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      background: #f8fafc;
      border-top: 2px solid #114a91;
    }

    /* FOOTER */
    .footer-section {
      display: flex;
      justify-content: space-between;
      margin-top: 25px;
      padding-top: 15px;
      border-top: 2px solid #114a91;
      gap: 20px;
    }

    .bank-details, .signature-section {
      flex: 1;
      font-size: 13px;
      padding: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      background: #f8fafc;
    }

    .bank-details .section-title {
      border-bottom: 1px solid #cbd5e1;
    }

    .signature-section {
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .signature-box {
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .signature-section img {
      width: 100px;
      height: 50px;
      object-fit: contain;
    }

    .authorized-text {
      font-weight: 600;
      color: #114a91;
      margin-top: 5px;
    }

    .company-name {
      font-weight: bold;
      margin-top: 3px;
      font-size: 13px;
    }

    /* BUTTONS */
    .action-buttons {
      text-align: center;
      margin: 20px 0;
      padding-top: 15px;
      border-top: 1px solid #e2e8f0;
    }

    .btn {
      display: inline-block;
      padding: 10px 18px;
      margin: 5px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .btn-print { 
      background: #3498db; 
      color: white; 
    }
    
    .btn-print:hover { 
      background: #2980b9; 
    }
    
    .btn-share { 
      background: #2ecc71; 
      color: white; 
    }
    
    .btn-share:hover { 
      background: #27ae60; 
    }

    @media print {
      .action-buttons { display: none; }
      body { 
        background: white; 
        margin: 0;
        padding: 0;
      }
      .invoice-box { 
        padding: 0;
        box-shadow: none;
        border-radius: 0;
      }
    }
  </style>
</head>

<body>
  <div class="invoice-box" id="invoice">
    <div class="invoice-title">Tax Invoice</div>

    <!-- Header -->
    <div class="invoice-header">
      <div class="company-info">
        <h1>{{ company['name'] }}</h1>
        <p>{{ company['address'] }}</p>
        <p>Phone: {{ company['phone'] }}</p>
        <p>GSTIN: {{ company['gst'] }}</p>
        <p>State: {{ company['state'] }}</p>
      </div>
      <div class="logo-container">
        {% if company['logo'] %}
          <img src="{{ url_for('static', filename='uploads/' + company['logo']) }}" alt="Company Logo">
        {% endif %}
      </div>
    </div>

    <!-- Customer Info -->
    <div class="details-section">
      <div class="customer-details">
        <div class="section-title">Bill To:</div>
        <div class="detail-row">
          <div class="detail-label">Name:</div>
          <div class="detail-value">{{ bill['customer_name'] }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Address:</div>
          <div class="detail-value">{{ customer['address'] if customer else 'N/A' }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Phone:</div>
          <div class="detail-value">{{ customer['phone'] if customer else 'N/A' }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">GSTIN:</div>
          <div class="detail-value">{{ customer['gst'] if customer else 'N/A' }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">State:</div>
          <div class="detail-value">{{ customer['state'] if customer else 'N/A' }}</div>
        </div>
      </div>

        <div class="invoice-details">
            <div class="section-title">Invoice Details</div>
            <div class="detail-row">
            <div class="detail-label">Invoice No:</div>
            <div class="detail-value">{{ bill['invoice_number'] }}</div>
            </div>
            <div class="detail-row">
            <div class="detail-label">Date:</div>
            <div class="detail-value">{{ bill['date'] }}</div>
            </div>
        </div>
    </div>

    <!-- Items Section -->
    <div class="items-section">
      <div class="section-title">Items</div>
      <table class="items-table">
        <thead>
          <tr>
            <th>Description</th>
            <th>HSN</th>
            <th>Qty</th>
            <th>Rate (‚Çπ)</th>
            <th>{{ bill['tax_type'] }}</th>
            <th>Tax (‚Çπ)</th>
            <th>Total (‚Çπ)</th>
          </tr>
        </thead>
        <tbody>
          {% set subtotal = 0 %}
          {% set totaltax = 0 %}
          {% for item in items %}
            {% set qty = item['qty'] | float %}
            {% set rate = item['rate'] | float %}
            {% set taxp = item['taxp'] | float if item['taxp'] else 18 %}
            {% set item_sub = qty * rate %}
            {% set tax = item_sub * taxp / 100 %}
            {% set total = item_sub + tax %}
            {% set subtotal = subtotal + item_sub %}
            {% set totaltax = totaltax + tax %}
            <tr>
              <td>{{ item['name'] }}</td>
              <td>{{ item['hsn'] or '-' }}</td>
              <td>{{ qty }}</td>
              <td>{{ rate | round(2) }}</td>
              <td>{{ taxp }}%</td>
              <td>{{ tax | round(2) }}</td>
              <td>{{ total | round(2) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Totals -->
    <div class="totals-section">
      <table class="totals-table">
        <tr>
          <td>Subtotal</td>
          <td>‚Çπ{{ subtotal | round(2) }}</td>
        </tr>
        {% if bill['extra_title'] and bill['extra_amount'] %}
        <tr>
          <td>{{ bill['extra_title'] }}</td>
          <td>‚Çπ{{ bill['extra_amount'] | round(2) }}</td>
        </tr>
        {% endif %}
        <tr>
          <td>Total Tax</td>
          <td>‚Çπ{{ totaltax | round(2) }}</td>
        </tr>
        <tr>
          <td><strong>Grand Total</strong></td>
          <td><strong>‚Çπ{{ bill['grand_total'] | round(2) }}</strong></td>
        </tr>
      </table>
    </div>

    <!-- Amount in Words -->
    <div class="amount-words">
      <strong>Amount in Words:</strong> {{ amount_in_words }}
    </div>

    <!-- Footer -->
    <div class="footer-section">
      <div class="bank-details">
        <div class="section-title">Bank Details</div>
        <div class="detail-row">
          <div class="detail-label">Bank:</div>
          <div class="detail-value">{{ company['bank_name'] or 'N/A' }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">A/C No:</div>
          <div class="detail-value">{{ company['account_number'] or 'N/A' }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">IFSC:</div>
          <div class="detail-value">{{ company['ifsc'] or 'N/A' }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Holder:</div>
          <div class="detail-value">{{ company['account_name'] or 'N/A' }}</div>
        </div>
      </div>

      <div class="signature-section">
        <div class="company-name">For,{{ company['name'] }}</div>
        <div class="signature-box">
          {% if company and company['signature'] %}
            <img src="{{ url_for('static', filename='uploads/' + company['signature']) }}" alt="Signature" />
          {% else %}
            <div style="color: #94a3b8; font-size: 12px;">Signature</div>
          {% endif %}
        </div>
        <div class="authorized-text">Authorized Signatory</div>
        
      </div>
    </div>
  </div>

  <!-- Buttons -->
  <div class="action-buttons">
    <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Print</button>
    <button class="btn btn-share" onclick="sharePDF()">üì§ Share PDF</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    async function sharePDF() {
      const invoice = document.getElementById("invoice");
      window.scrollTo(0, 0);

      const opt = {
        margin: [0.2, 0.2, 0.2, 0.2],
        filename: "Invoice_{{ bill['invoice_number'] }}.pdf",
        image: { type: "jpeg", quality: 1 },
        html2canvas: { 
          scale: 3, 
          useCORS: true, 
          scrollY: 0,
          backgroundColor: '#FFFFFF'
        },
        jsPDF: { unit: "in", format: "a4", orientation: "portrait" },
      };

      try {
        const blob = await html2pdf().set(opt).from(invoice).outputPdf("blob");
        const file = new File([blob], opt.filename, { type: "application/pdf" });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            title: "Tax Invoice - {{ bill['invoice_number'] }}",
            text: "Please find the attached tax invoice.",
            files: [file],
          });
        } else {
          // Fallback: download the PDF
          html2pdf().set(opt).from(invoice).save();
        }
      } catch (error) {
        console.error('Error generating PDF:', error);
        // Fallback to print if PDF generation fails
        window.print();
      }
    }
  </script>
</body>
</html>