<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bill History</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 15px;
    }

    h2 {
      text-align: center;
      margin-bottom: 15px;
    }

    a {
      text-decoration: none;
      color: #007bff;
    }

    .bill-card {
      background: #fff;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    h3 {
      font-size: 16px;
      margin-bottom: 8px;
      word-break: break-word;
    }

    .meta {
      color: #555;
      font-size: 14px;
      margin-bottom: 10px;
      line-height: 1.5;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
    }

    th {
      background: #f0f0f0;
    }

    .summary td {
      text-align: right;
      font-weight: bold;
      padding-right: 10px;
    }

    button {
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      margin-left: 5px;
      cursor: pointer;
      font-size: 13px;
    }

    button:hover {
      opacity: 0.8;
    }

    button:first-child {
      background: #3b82f6;
      color: #fff;
    }

    button:last-child {
      background: #dc2626;
      color: #fff;
    }

    /* Mobile adjustments */
    @media (max-width: 600px) {
      h2 {
        font-size: 18px;
      }

      .bill-card {
        padding: 12px;
      }

      table, th, td {
        font-size: 12px;
        padding: 4px;
      }

      .meta {
        font-size: 13px;
      }

      button {
        display: inline-block;
        margin-top: 5px;
        width: 48%;
      }
    }
  </style>
</head>
<body>
  <h2>üìú Bill History</h2>
  <p style="text-align:center;"><a href="/">üè† Back to Home</a></p>

  {% for bill in bills %}
  <div class="bill-card">
    <h3>Invoice: {{ bill['invoice_number'] }} | Date: {{ bill['date'] }}</h3>
    <p><strong>Tax Type:</strong> {{ bill['tax_type'] or 'N/A' }}</p>


    <div class="meta">
      <strong>Customer:</strong> {{ bill['customer_name'] }}<br>
      <strong>Address:</strong> {{ bill['customer']['address'] or 'N/A' }}<br>
      <strong>Phone:</strong> {{ bill['customer']['phone'] or 'N/A' }}<br>
      <strong>GST:</strong> {{ bill['customer']['gst'] or 'N/A' }}<br>
      <strong>State:</strong> {{ bill['customer']['state'] or 'N/A' }}
    </div>

    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Item</th>
            <th>HSN</th>
            <th>Qty</th>
            <th>Rate</th>
            <th>Tax (18%)</th>
            <th>Total</th>

          </tr>
        </thead>
        <tbody>
            {% set subtotal = namespace(value=0.0) %}
            {% set total_tax = namespace(value=0.0) %}

            {% for item in bill['items'] %}
                {% set qty = (item['qty'] | float) %}
                {% set rate = (item['rate'] | float) %}
                {% set item_sub = qty * rate %}
                {% set item_tax = (item_sub * 0.18) %}
                {% set item_total = item_sub + item_tax %}
                {% set subtotal.value = subtotal.value + item_sub %}
                {% set total_tax.value = total_tax.value + item_tax %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ item['name'] }}</td>
                    <td>{{ item['hsn'] or '' }}</td>
                    <td>{{ qty | round(2) }}</td>
                    <td>‚Çπ{{ rate | round(2) }}</td>
                    <td>‚Çπ{{ item_tax | round(2) }}</td>
                    <td>‚Çπ{{ item_total | round(2) }}</td>

                </tr>
            {% endfor %}

            {% if bill['extra_title'] and bill['extra_amount'] %}
                <tr class="summary">
                <td colspan="5">{{ bill['extra_title'] }}:</td>
                <td>‚Çπ{{ bill['extra_amount'] | round(2) }}</td>
                </tr>
            {% endif %}


            <tr class="summary"><td colspan="5">Subtotal:</td><td>‚Çπ{{ subtotal.value | round(2) }}</td></tr>
            <tr class="summary"><td colspan="5">Tax (18%):</td><td>‚Çπ{{ total_tax.value | round(2) }}</td></tr>
            <tr class="summary"><td colspan="5"><strong>Grand Total:</strong></td><td><strong>‚Çπ{{ bill['grand_total'] | round(2) }}</strong></td></tr>
        </tbody>

      </table>
    </div>

    <div style="margin-top:10px;text-align:right;">
        <button onclick="window.location.href='/edit-bill/{{ bill['id'] }}'">‚úèÔ∏è Edit</button>
        <button onclick="window.location.href='/print-bill/{{ bill['id'] }}'">üñ®Ô∏è Print</button>
        <button onclick="deleteBill({{ bill['id'] }})">üóëÔ∏è Delete</button>
    </div>

  </div>
  {% endfor %}

  <script>
    async function deleteBill(bill_id) {
      if (!confirm("Are you sure you want to delete this bill?")) return;
      const res = await fetch(`/delete-bill/${bill_id}`, { method: 'POST' });
      const data = await res.json();
      if (data.success) {
        alert(data.message);
        location.reload();
      } else {
        alert("Failed to delete bill.");
      }
    }
  </script>
</body>
</html>
